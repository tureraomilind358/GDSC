<div class="dashboard-container">
  <app-loading-spinner *ngIf="isLoading"></app-loading-spinner>

  <!-- Header Section -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="header-title">
        <h1>
          <mat-icon>dashboard</mat-icon>
          Admin Dashboard
        </h1>
        <p>Welcome back! Here's what's happening with your institute today.</p>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="refreshData()" [disabled]="isRefreshing">
          <mat-icon *ngIf="isRefreshing">hourglass_empty</mat-icon>
          <mat-icon *ngIf="!isRefreshing">refresh</mat-icon>
          {{ isRefreshing ? 'Refreshing...' : 'Refresh' }}
        </button>
                 <button mat-raised-button color="accent" (click)="exportDashboardReport()">
           <mat-icon>download</mat-icon>
           Export Report
         </button>
         <button mat-raised-button color="warn" (click)="testApiCalls()">
           <mat-icon>bug_report</mat-icon>
           Test API Calls
         </button>
      </div>
    </div>
  </div>

  <!-- Filter Section -->
  <mat-card class="filter-card">
    <mat-card-content>
      <form [formGroup]="filterForm" class="filter-form">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Time Range</mat-label>
            <mat-select formControlName="timeRange">
              <mat-option *ngFor="let range of timeRanges" [value]="range.value">
                {{ range.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Centre</mat-label>
            <mat-select formControlName="centreId">
              <mat-option value="">All Centres</mat-option>
              <mat-option *ngFor="let centre of centres" [value]="centre.id">
                {{ centre.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Course</mat-label>
            <mat-select formControlName="courseId">
              <mat-option value="">All Courses</mat-option>
              <mat-option *ngFor="let course of courses" [value]="course.id">
                {{ course.title }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <mat-card class="stat-card students">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>school</mat-icon>
          </div>
          <div class="stat-details">
            <h3>{{ stats.totalStudents | number }}</h3>
            <p>Total Students</p>
            <span class="growth" [class.positive]="stats.monthlyGrowth >= 0" [class.negative]="stats.monthlyGrowth < 0">
              <mat-icon>{{ getGrowthIcon(stats.monthlyGrowth) }}</mat-icon>
              {{ formatPercentage(Math.abs(stats.monthlyGrowth)) }}
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card courses">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>book</mat-icon>
          </div>
          <div class="stat-details">
            <h3>{{ stats.totalCourses | number }}</h3>
            <p>Active Courses</p>
            <span class="growth positive">
              <mat-icon>trending_up</mat-icon>
              {{ formatPercentage(8.5) }}
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card revenue">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>account_balance_wallet</mat-icon>
          </div>
          <div class="stat-details">
            <h3>{{ formatCurrency(stats.totalRevenue) }}</h3>
            <p>Total Revenue</p>
            <span class="growth positive">
              <mat-icon>trending_up</mat-icon>
              {{ formatPercentage(15.2) }}
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card performance">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>analytics</mat-icon>
          </div>
          <div class="stat-details">
            <h3>{{ formatPercentage(stats.averageGrade) }}</h3>
            <p>Average Grade</p>
            <span class="growth positive">
              <mat-icon>trending_up</mat-icon>
              {{ formatPercentage(2.1) }}
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Main Content Grid -->
  <div class="dashboard-grid">
    <!-- Management Shortcuts -->
    <mat-card class="actions-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>admin_panel_settings</mat-icon>
          Management
        </mat-card-title>
        <mat-card-subtitle>Quick navigation to admin sections</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="quick-actions">
          <a mat-raised-button color="primary" routerLink="/admin/manage-centres">
            <mat-icon>business</mat-icon>
            Manage Centres
          </a>
          <a mat-raised-button color="primary" routerLink="/admin/manage-exams">
            <mat-icon>assignment</mat-icon>
            Manage Exams
          </a>
          <a mat-raised-button color="primary" routerLink="/admin/manage-users">
            <mat-icon>group</mat-icon>
            Manage Users
          </a>
          <a mat-raised-button color="accent" routerLink="/certification">
            <mat-icon>verified</mat-icon>
            Certification
          </a>
          <a mat-raised-button color="accent" routerLink="/examiner">
            <mat-icon>rule</mat-icon>
            Examiner
          </a>
          <a mat-raised-button color="warn" routerLink="/admin/reports">
            <mat-icon>insert_chart</mat-icon>
            Reports
          </a>
          <a mat-raised-button color="primary" routerLink="/candidate/certificates">
            <mat-icon>card_membership</mat-icon>
            Certificates
          </a>
          <a mat-raised-button color="primary" routerLink="/candidate/exam-result">
            <mat-icon>leaderboard</mat-icon>
            Exam Result
          </a>
          <a mat-raised-button color="primary" routerLink="/candidate/exam-list">
            <mat-icon>list_alt</mat-icon>
            Exam List
          </a>
        </div>
      </mat-card-content>
    </mat-card>
    <!-- Recent Activities -->
    <mat-card class="activity-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>timeline</mat-icon>
          Recent Activities
        </mat-card-title>
        <mat-card-subtitle>Latest system activities and updates</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="activity-list">
          <div *ngFor="let activity of recentActivities" class="activity-item" (click)="viewActivityDetails(activity)">
            <div class="activity-icon" [class]="activity.type">
              <mat-icon>{{ getActivityIcon(activity.type) }}</mat-icon>
            </div>
            <div class="activity-content">
              <h4>{{ activity.name }}</h4>
              <p>{{ activity.description }}</p>
              <span class="activity-time">{{ activity.date | date:'short' }}</span>
            </div>
            <div class="activity-status">
              <mat-chip [color]="getActivityColor(activity.status)" selected>
                {{ activity.status }}
              </mat-chip>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Notifications -->
    <mat-card class="notification-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>notifications</mat-icon>
          Notifications
        </mat-card-title>
        <mat-card-subtitle>Important updates and alerts</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="notification-list">
          <div *ngFor="let notification of notifications" class="notification-item" 
               [class.unread]="!notification.isRead"
               (click)="markNotificationAsRead(notification)">
            <div class="notification-icon" [class]="notification.type">
              <mat-icon>{{ getNotificationIcon(notification.type) }}</mat-icon>
            </div>
            <div class="notification-content">
              <h4>{{ notification.title }}</h4>
              <p>{{ notification.message }}</p>
              <span class="notification-time">{{ notification.date | date:'short' }}</span>
            </div>
            <div class="notification-badge" *ngIf="!notification.isRead">
              <mat-icon>fiber_manual_record</mat-icon>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Performance Overview -->
    <mat-card class="performance-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>bar_chart</mat-icon>
          Performance Overview
        </mat-card-title>
        <mat-card-subtitle>Course performance metrics</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="performance-metrics">
          <div class="metric-item">
            <div class="metric-label">Pass Rate</div>
            <div class="metric-value">{{ formatPercentage(stats.passRate) }}</div>
            <mat-progress-bar mode="determinate" [value]="stats.passRate" color="accent"></mat-progress-bar>
          </div>
          <div class="metric-item">
            <div class="metric-label">Attendance Rate</div>
            <div class="metric-value">{{ formatPercentage(stats.attendanceRate) }}</div>
            <mat-progress-bar mode="determinate" [value]="stats.attendanceRate" color="primary"></mat-progress-bar>
          </div>
          <div class="metric-item">
            <div class="metric-label">Active Enrollments</div>
            <div class="metric-value">{{ stats.activeEnrollments | number }}</div>
            <mat-progress-bar mode="determinate" [value]="(stats.activeEnrollments / stats.totalStudents) * 100" color="warn"></mat-progress-bar>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Quick Actions -->
    <mat-card class="actions-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>flash_on</mat-icon>
          Quick Actions
        </mat-card-title>
        <mat-card-subtitle>Common administrative tasks</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="quick-actions">
          <button mat-raised-button color="primary" (click)="addNewStudent()">
            <mat-icon>person_add</mat-icon>
            Add Student
          </button>
          <button mat-raised-button color="accent" (click)="createNewCourse()">
            <mat-icon>add_circle</mat-icon>
            Create Course
          </button>
          <button mat-raised-button color="warn" (click)="scheduleExam()">
            <mat-icon>schedule</mat-icon>
            Schedule Exam
          </button>
          <button mat-raised-button color="primary" (click)="generateReport()">
            <mat-icon>assessment</mat-icon>
            Generate Report
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Charts Section -->
  <div class="charts-section">
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>show_chart</mat-icon>
          Enrollment Trends
        </mat-card-title>
        <mat-card-subtitle>Monthly student enrollment patterns</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <!-- Chart placeholder - would be replaced with actual chart library -->
          <div class="chart-placeholder">
            <mat-icon>bar_chart</mat-icon>
            <p>Enrollment trends chart would be displayed here</p>
            <div class="chart-data">
              <div *ngFor="let item of enrollmentTrends" class="chart-bar">
                <div class="bar-label">{{ item.month }}</div>
                <div class="bar" [style.height.%]="(item.enrollments / 300) * 100"></div>
                <div class="bar-value">{{ item.enrollments }}</div>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>pie_chart</mat-icon>
          Course Distribution
        </mat-card-title>
        <mat-card-subtitle>Student distribution across courses</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <div class="chart-placeholder">
            <mat-icon>pie_chart</mat-icon>
            <p>Course distribution chart would be displayed here</p>
            <div class="pie-data">
              <div *ngFor="let item of courseDistribution" class="pie-segment">
                <div class="segment-color" [style.background-color]="getColorForItem(item)"></div>
                <div class="segment-label">{{ item.course }}</div>
                <div class="segment-value">{{ item.students }}</div>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Detailed Statistics Table -->
  <mat-card class="stats-table-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>table_chart</mat-icon>
        Detailed Statistics
      </mat-card-title>
      <mat-card-subtitle>Comprehensive system statistics</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="stats-grid-detailed">
        <div class="stat-detail">
          <h4>Total Exams</h4>
          <p>{{ stats.totalExams | number }}</p>
        </div>
        <div class="stat-detail">
          <h4>Completed Exams</h4>
          <p>{{ stats.completedExams | number }}</p>
        </div>
        <div class="stat-detail">
          <h4>Total Centres</h4>
          <p>{{ stats.totalCentres | number }}</p>
        </div>
        <div class="stat-detail">
          <h4>Total Users</h4>
          <p>{{ stats.totalUsers | number }}</p>
        </div>
        <div class="stat-detail">
          <h4>Monthly Growth</h4>
          <p [class]="getGrowthColor(stats.monthlyGrowth)">
            {{ getGrowthIcon(stats.monthlyGrowth) }} {{ formatPercentage(stats.monthlyGrowth) }}
          </p>
        </div>
        <div class="stat-detail">
          <h4>System Health</h4>
          <p class="healthy">Excellent</p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
